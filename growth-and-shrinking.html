<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Growth and Shrinking</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Test.check</span> <span class="project-version">0.10.0-alpha4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="api-docs-for-older-versions.html"><div class="inner"><span>API Docs for Older Versions</span></div></a></li><li class="depth-1 "><a href="cheatsheet.html"><div class="inner"><span>test.check cheatsheet</span></div></a></li><li class="depth-1 "><a href="generator-examples.html"><div class="inner"><span>Generator Examples</span></div></a></li><li class="depth-1  current"><a href="growth-and-shrinking.html"><div class="inner"><span>Growth and Shrinking</span></div></a></li><li class="depth-1 "><a href="intro.html"><div class="inner"><span>Introduction to test.check</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clojure</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></div></li><li class="depth-3"><a href="clojure.test.check.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>check</span></div></a></li><li class="depth-4 branch"><a href="clojure.test.check.clojure-test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clojure-test</span></div></a></li><li class="depth-4 branch"><a href="clojure.test.check.generators.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generators</span></div></a></li><li class="depth-4 branch"><a href="clojure.test.check.properties.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>properties</span></div></a></li><li class="depth-4"><a href="clojure.test.check.results.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>results</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#growth-and-shrinking" name="growth-and-shrinking"></a>Growth and Shrinking</h1>
<p>Sizing in test.check seems simple at first glance, but there are subtleties that are important to understand to ensure that your tests are covering what you expect them to, and that failing cases can shrink in an effective way.</p>
<p>It’s useful to keep in mind that the way test.check controls the “size” of the data it generates is entirely different from how it shrinks failing examples, and we’ll cover both of these processes below.</p>
<h2><a href="#growth" name="growth"></a>Growth</h2>
<h3><a href="#the-parameter" name="the-parameter"></a>The <code>size</code> Parameter</h3>
<p>Internally, a generator cannot produce a value without specifying what <code>size</code> the value should be. This is what allows test.check to start a test run by trying very simple values first, and gradually trying larger and larger values. The meaning of <code>size</code> depends on the generator; some generators ignore it altogether.</p>
<p>You can see how <code>size</code> affects different generators by experimenting with the <code>gen/generate</code> function, which takes an optional <code>size</code> argument:</p>
<pre><code class="clojure">(defn sizing-sample
  [g]
  (into {}
   (for [size [0 5 25 200]]
     [size
      (repeatedly 5 #(gen/generate g size))])))

;; with gen/nat, the integer is roughly proportional to the `size`
(sizing-sample gen/nat)
;; =&gt; {0   (0 0 0 0 0),
;;     5   (4 1 3 3 5),
;;     25  (12 8 24 25 22),
;;     200 (63 143 31 199 7)}

;; with gen/large-integer, the integer can be much larger
(sizing-sample gen/large-integer)
;; =&gt; {0   (-1 0 -1 -1 -1),
;;     5   (1 6 7 4 2),
;;     25  (-1 55798 23198 -11 6124159),
;;     200 (8371567737
;;          -393642130983883
;;          -56826587109
;;          114071285698586153
;;          5723723802814291)}

;; a collection generator grows the collection size and the
;; size of its elements
(dissoc (sizing-sample (gen/vector gen/nat)) 200)
;; =&gt; {0  ([] [] [] [] []),
;;     5  ([1 0 4 3 4] [3] [] [2 0] [2 2 4]),
;;     25 ([8 10 0 16 7 7 2 19 16 10]
;;         [16 8 0 18 11 23 11 7 1 19 10 4 0 23 17 2 17 12 1 20]
;;         [15 19 7 6 4]
;;         [6 5 14 12 19 12 7 13 17 10 16 6 9 1]
;;         [19 16 5 22 2 5 10 3 6 7 22 19 21 10 4 22 23 5 9 21 19 16 2])}

;; unless we fix the size of the collection
(sizing-sample (gen/vector gen/large-integer 3))
;; =&gt; {0 ([-1 -1 -1] [-1 0 -1] [-1 0 -1] [0 0 -1] [0 0 -1]),
;;     5 ([-10 -1 -1] [4 -14 15] [2 2 -1] [-3 -7 2] [-2 0 0]),
;;     25 ([-4417 32 189]
;;         [12886 576 -2]
;;         [0 -2 -89799]
;;         [108 -250318 -1218212]
;;         [-10 -27 -5]),
;;     200 ([-8526639064861 -44 2311]
;;          [819670069072907 -4481451104804003250 -81]
;;          [-1985273 781374 -480118376]
;;          [-2038 2593 -5355]
;;          [143974988 4 209260326382094708])}

;; gen/uuid completely ignores `size`
(sizing-sample gen/uuid)
;; =&gt; {0 (#uuid "29ec3e6f-e35c-466f-b9d5-fa27e043743d"
;;        #uuid "7bb1c53d-0b12-4be0-a2c5-b7d6a406f64f"
;;        #uuid "8f07cab1-4e3d-4bd1-a699-6d653b353588"
;;        #uuid "b2e65dcb-fad1-4f1e-afe6-5645d1759a9d"
;;        #uuid "83d9ca17-cc07-4515-bf22-625e1e537943"),
;;     5 (#uuid "f1a35527-128a-4cda-b9ba-d0fec4255674"
;;        #uuid "f7a7f621-5e84-4d09-b3e3-849bebfea048"
;;        #uuid "d92aa9f9-7be6-4e02-80a7-ab89d9074b48"
;;        #uuid "c5f24f29-1472-454a-9171-34a2d74074b1"
;;        #uuid "c14ac2f6-a31a-4c0b-8e50-273feac6dbda"),
;;     25 (#uuid "008a8dcb-11b1-41cc-87b7-5b7b1b704e8e"
;;         #uuid "f89c245a-7667-4d2f-9a88-b33c92ad09ca"
;;         #uuid "dc209d21-cfbc-4e3e-a338-7a8b146084b4"
;;         #uuid "c9585173-a4f5-4f3b-9a98-7eecc4801007"
;;         #uuid "b10196fb-9cdb-4148-8d99-dea80be6d7fa"),
;;     200 (#uuid "b9a70100-4b02-404b-9de4-611ad5a2cefe"
;;          #uuid "32ca9f24-3248-476a-ab9f-d58c9aa5df9c"
;;          #uuid "9de09d09-0121-4ffe-b7a7-37cb95191bcb"
;;          #uuid "bcaeeaf8-4225-40d9-a2b4-7ba2c417a3f0"
;;          #uuid "6153d4e4-038c-4e73-be0c-2394b3078e25")}
</code></pre>
<h3><a href="#how-changes-over-a-test-run" name="how-changes-over-a-test-run"></a>How <code>size</code> changes over a test run</h3>
<p><code>clojure.test.check/quick-check</code> generates the input for the first trial using <code>size=0</code>, for the second trial it uses <code>size=1</code>, and continues incrementing until the 200th trial with <code>size=199</code>, after which it starts over. In general it uses <code>(cycle (range 200))</code>.</p>
<p>Test.check starts with small sizes so that it will catch easy bugs quickly without needing to generate very large input and then shrink it, and so that edge cases produced by small sizes have a good chance of being caught. Custom generators that ignore the <code>size</code> parameter are thwarting this feature.</p>
<p>Also see the warning about small test counts below.</p>
<h3><a href="#controlling" name="controlling"></a>Controlling <code>size</code></h3>
<p>Custom generators can use and modify <code>size</code> in several different ways.</p>
<h4><code>gen/sized</code></h4>
<p><code>gen/sized</code> is essentially a facility for “reading” the size as you create a generator.</p>
<pre><code class="clojure">(def g
  (gen/sized
   (fn [size]
    (gen/let [x gen/large-integer]
      (format "I generated %d using size=%d!" x size)))))

(gen/sample g)
;; =&gt; ("I generated -1 using size=0!"
;;     "I generated 0 using size=1!"
;;     "I generated -1 using size=2!"
;;     "I generated 0 using size=3!"
;;     "I generated -1 using size=4!"
;;     "I generated 2 using size=5!"
;;     "I generated 0 using size=6!"
;;     "I generated -2 using size=7!"
;;     "I generated 12 using size=8!"
;;     "I generated -2 using size=9!")
</code></pre>
<h4><code>gen/resize</code></h4>
<p><code>gen/resize</code> lets you pin a generator to a particular <code>size</code></p>
<pre><code class="clojure">(def g
  (gen/sized
   (fn [size]
    (gen/let [x (gen/resize 100 gen/large-integer)]
      (format "I generated %d, even though size=%d!" x size)))))

(gen/sample g)
;; =&gt; ("I generated 2047953455, even though size=0!"
;;     "I generated -126726750629, even though size=1!"
;;     "I generated 50066179923, even though size=2!"
;;     "I generated 2078170872141134, even though size=3!"
;;     "I generated 678227175, even though size=4!"
;;     "I generated 3858768648, even though size=5!"
;;     "I generated -23231577, even though size=6!"
;;     "I generated 4, even though size=7!"
;;     "I generated 3503438568408, even though size=8!"
;;     "I generated 186422559275, even though size=9!")
</code></pre>
<h4><code>gen/scale</code></h4>
<p><code>gen/scale</code> is a convenient way to modify the <code>size</code> that a generator sees (which you could do more tediously by combining <code>gen/sized</code> and <code>gen/resize</code>).</p>
<pre><code class="clojure">(def gen-small-vectors-of-large-numbers
  (gen/scale #(max 0 (Math/log %))
             (gen/vector (gen/scale #(* % 100) gen/large-integer))))

(gen/sample gen-small-vectors-of-large-numbers 20)
;; =&gt; ([]
;;     []
;;     []
;;     [234236101]
;;     [34663197938259]
;;     [-15]
;;     [87]
;;     []
;;     []
;;     [-5310368659078251]
;;     [-8403929563691 126041240]
;;     []
;;     []
;;     []
;;     []
;;     [-84306261785]
;;     [35060841580649472 45255404980]
;;     []
;;     [61658595345 277549824780866555]
;;     [])
</code></pre>
<h3><a href="#gotchas" name="gotchas"></a>Gotchas</h3>
<h4><a href="#integer-generators" name="integer-generators"></a>Integer generators</h4>
<p>Test.check originally contained six integer generators which are all variants of the same thing:</p>
<pre><code class="clojure">(gen/sample (gen/tuple gen/nat       gen/int
                       gen/pos-int   gen/neg-int
                       gen/s-pos-int gen/s-neg-int))

;; =&gt; ([0 0 0 0 1 -1]
;;     [1 1 0 0 1 -2]
;;     [0 2 0 -1 2 -2]
;;     [0 0 2 -2 2 -3]
;;     [3 -2 2 -2 5 -2]
;;     [3 -4 3 -2 5 -2]
;;     [0 0 1 -2 5 -4]
;;     [6 5 3 -6 2 -4]
;;     [1 -2 8 -5 4 -5]
;;     [4 -6 2 -9 8 -2])
</code></pre>
<p>Besides the confusing names, the big gotcha is that the range of these generators is is more or less strictly bounded by <code>size</code>, and so any use of them will by default not test numbers bigger than <code>200</code>, which is unacceptable coverage for a lot of applications. <code>gen/large-integer</code> should avoid this issue. The small-integer generators can still be useful for certain uses.</p>
<h4><a href="#small-test-count" name="small-test-count"></a>Small Test Count</h4>
<p>Due to the use of <code>(cycle (range 200))</code> as the <code>size</code> progression during a test run (described above), tests that use less than 200 trials will not be exposed to the normal range of sizes, and in particular tests that run less than ~10 trials will be getting very poor coverage.</p>
<p>If you don’t want to run very many trials for some reason, you can mitigate this with <code>gen/scale</code>; e.g.:</p>
<pre><code class="clojure">;; uses sizes 0,20,40,60,80,100,120,140,160,180
(tc/quick-check 10
 (prop/for-all [x (gen/scale #(* 20 %) g)]
   (f x)))
</code></pre>
<h4><code>gen/sample</code></h4>
<p><code>gen/sample</code> starts with very small sizes in the same way that the <code>quick-check</code> function does. This can be misleading to users who don’t expect that and take the first ten results from <code>gen/sample</code> to be representative of the distribution of a generator. Using <code>gen/generate</code> with an explicit <code>size</code> argument can be a better way of learning about the distribution of a generator.</p>
<h4><a href="#collection-composition" name="collection-composition"></a>Collection composition</h4>
<p><em>See <a href="http://dev.clojure.org/jira/browse/TCHECK-106">TCHECK-106</a></em></p>
<p>test.check’s collection generators by default select a size for the generated collection that is proportional to the <code>size</code> parameter.</p>
<p>This generally works well enough, but when creating generators of nested collections it can lead to Very Large output, in the worst case exhausting available memory.</p>
<pre><code class="clojure">(defn max-size
  [colls]
  (-&gt;&gt; colls (map flatten) (map count) (apply max)))

(-&gt; gen/nat
    (gen/vector)
    (gen/vector)
    (gen/sample 200)
    (max-size))
;; =&gt; 4747

(-&gt; gen/nat
    (gen/vector)
    (gen/vector)
    (gen/vector)
    (gen/sample 200)
    (max-size))
;; =&gt; 195635
</code></pre>
<p>This can be mitigated with strategic resizing.</p>
<h2><a href="#shrinking" name="shrinking"></a>Shrinking</h2>
<p>Despite the conceptual similarity, the shrinking algorithm has nothing to do with the <code>size</code> parameter. <code>size</code> affects the distribution of a random process, while shrinking is entirely deterministic and based on the properties of the basic generators and the combinators.</p>
<h3><a href="#gotchas" name="gotchas"></a>Gotchas</h3>
<h4><a href="#unnecessary" name="unnecessary"></a>Unnecessary <code>bind</code></h4>
<p><em>See <a href="http://dev.clojure.org/jira/browse/TCHECK-112">TCHECK-112</a></em></p>
<p><code>gen/bind</code> (and multi-clause uses of <code>gen/let</code>) is a powerful combinator that allows you to combine generators in “phases”, where the later generators can make use of values generated in earlier generators. This can be very useful, but it also is difficult to shrink in a general way (see the details in the jira ticket linked above for an example of this).</p>
<p>This means that if you care about the effectiveness of shrinking, it can be worth taking care not to use <code>gen/bind</code> where you don’t have to.</p>
<p>For example, say you wanted to generate a collection of an even number of integers. You might think to do this by first generating an even number for the length, and then using that with <code>gen/vector</code>:</p>
<pre><code class="clojure">(def gen-an-even-number-of-integers
  (gen/let [even-number (gen/fmap #(* 2 %) gen/nat)]
    (gen/vector gen/large-integer even-number))
  ;; or, rewritten without gen/let:
  #_
  (gen/bind (gen/fmap #(* 2 %) gen/nat)
            (fn [even-number]
              (gen/vector gen/large-integer even-number))))

(def gen-strictly-increasing-integers
  (gen/bind gen/nat #(gen-strictly-increasing-integers* % 0)))

(gen/sample gen-an-even-number-of-integers)
;; =&gt; ([]
;;     [-1 -1]
;;     []
;;     []
;;     [-1 -4 0 -1 -2 2]
;;     [0 2]
;;     [6 -1 1 4 8 30 -2 0 21 -2 -1 0]
;;     [2 -2]
;;     [0 -1 7 -33 9 -49 14 14 1 1 -1 0 1 -2]
;;     [0 2 -1 -9])
</code></pre>
<p>It looks okay, but we can see a problem when shrinking</p>
<pre><code class="clojure">(tc/quick-check
 10000
 (prop/for-all [xs gen-an-even-number-of-integers]
   (not-any? #{42} xs)))

;; =&gt; {:result false,
;;     :seed 1482063539636,
;;     :failing-size 176,
;;     :num-tests 177,
;;     :fail [[-92431438766962 63530 -164135493216497125 -3270829858185774102
;;             -260351529 -59352395648111 -4 -17469 -31636041044035
;;             7336711261875630 -1636343167264 -20912505735276 -23753842660
;;             13368897139830488 -1 -250220724 24370059524 -8266208340
;;             949778971431 -2233935110 -10 -226980 -166150097914784515
;;             1446375390291034 17977873032 -306481593932634684 2 321887
;;             1535082621176844 24757631603 -15034747392805020 -248163661633
;;             -2272021814312959965 -1045247795284 177163345 13467
;;             -355036687887336641 -4098005768175 -8055 -6317647 133903089
;;             3881 42630713210694061 -2673915744452669 421802903098966
;;             -34741965 1630280301 231213827 858102836152006 5282
;;             -269037059 -4985695680423 -187884359879 -68958514179
;;             1356369075861 -1 5701573467 -9 3993 -66360585914444
;;             1796329244719094 -9139976096708138 -11216 908965 17156900
;;             5559124946 13403 -2345413999 42 1 -76248253307297 222887742816784
;;             1274360 -68929 1 -213900 -122103507959521 2767011893757957
;;             -3626024977 84758031 461767131016 -122390014709033 -1052250928741535
;;             1 383 -575550 -8793837628976134 -540423902910181208
;;             7896218 -49725987 -68869268253 -470133169 -7407245227931
;;             -2266127667584039 -60700760 7759 14242030181 -565807123157122480
;;             -21599378358624 1000368132 -1 109045164 23447410579428773
;;             1966123182 949341425 16444393 60598 340542 -187842543295
;;             3676708478 -236529145197024202 -791408585920527 -3452127625272781
;;             -132208027103 25 -17500698053396417 -3375613232 -88206409961854
;;             -3368 7 -179071081209 16894761949763 -132946664 -30990191248478947
;;             402283570687771 29732288327985 -6211 -885340544041821
;;             -2134764587 -16103 518432298883356507 -30801 -311015444053486
;;             -52408941698 -2282761018048237612 438556242]],
;;     :shrunk {:total-nodes-visited 97,
;;              :depth 72,
;;              :result false,
;;              :smallest [[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
;;                          0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
;;                          0 0 0 0 0 0 0 0 0 0 0 0 42 0]]}}
</code></pre>
<p>Test.check wasn’t able to shrink the collection to the optimal size (2 elements) because of the structure of the generators (though it did manage to shrink from 136 to 70 elements). <code>gen/vector</code> is not able to remove elements from the vector when shrinking because it was called with a fixed size. So the only way to shrink the size of the vector is to shrink the value from <code>(gen/fmap #(* 2 %) gen/nat)</code>. This is one of the things that <code>gen/bind</code> tries, but when it shrinks the <code>even-number</code>, it has no choice but to create an entirely new generator from <code>gen-vector</code> and generate a fresh value that’s unrelated to the original failing collection. This fresh value is highly unlikely to also fail, and so that part of the shrinking algorithm is unlikely to be very fruitful (though sometimes it works, like in the example above where we were lucky to reduce the size from 136 to 70).</p>
<p>Sometimes there are natural ways to write a generator that do not use <code>gen/bind</code>. For example, in this case we could use <code>gen/vector</code> without a fixed size, and modify it with <code>gen/fmap</code> to ensure it has an even number of elements:</p>
<pre><code class="clojure">(def gen-an-even-number-of-integers
  (gen/let [xs (gen/vector gen/large-integer)]
    (cond-&gt; xs (odd? (count xs)) pop))
  ;; or, rewritten without gen/let:
  #_
  (gen/fmap (fn [xs] (cond-&gt; xs (odd? (count xs)) pop))
    (gen/vector gen/large-integer)))

(gen/sample gen-an-even-number-of-integers)
;; =&gt; ([]
;;     []
;;     []
;;     [0 0]
;;     [-6 0]
;;     [0 6]
;;     [22 -2 -2 0]
;;     []
;;     [0 -2 15 95]
;;     [0 -7 -205 -9])

;; =&gt; {:result false,
;;     :seed 1482064393801,
;;     :failing-size 160,
;;     :num-tests 161,
;;     :fail [[-20 3758 -174 2908907278 7767028 6628657334113049 -7409556399
;;             -3379156667294 -473722 760549137 -7137938397056 124401939
;;             1590227088 174 482329 4972338 -53955167617312 -237816
;;             1 -13159175 2 1911311087865 -2675112025 -391133804902
;;             -1444282617174675 1477509406066 138075 -3555024567808
;;             0 -26579022516 0 5182 -82958251 -1287 -35417824257454314
;;             -129794819488 42 1642761942897 975833887255494324 701657767868417
;;             3940940 2 458 -1337864380187855428 -6716451 23621121
;;             1 -826778832808 -2 -137892 6996928807632 -1 -506146269826334582
;;             -23783 -419873644169 3928808977969 0 -3595621317791
;;             -66706208260298 -13099314 10721686280827793 -50904466
;;             -6134528453735 24779423757 -43 1042490490 134213823314 -29]],
;;     :shrunk {:total-nodes-visited 115, :depth 68, :result false, :smallest [[42 0]]}}
</code></pre></div></div></div></body></html>